= Peak Envelope Follower

include::../../common.adoc[]

During the attack phase of an audio signal, the peak envelope follower closely tracks the maximum peak level. When the signal level drops below the peak, the follower gradually releases the peak level with an exponential decay. This allows the follower to accurately capture the dynamic changes in the audio signal while avoiding sudden downward fluctuations.

image::peak-envelope-follower.png[alt="Peak Envelope Follower", title="Peak envelope follower response (envelope: orange, signal: blue)", width="750px" align=center, link={imagesdir}/peak-envelope-follower.png]

Note that we are using the absolute value of the signal to capture both the positive and negative sides of the waveform in the image of the waveform above (dark blue). The peak envelope follower does not automatically perform this action. This enables you to take only the positive (or negative) peaks, or the square of the signal, for instance.

== Include

```c++
#include <q/fx/envelope.hpp>
```

== Declaration

```c++
struct peak_envelope_follower
{
                            peak_envelope_follower(duration release, float sps);

    float                   operator()(float s);
    float                   operator()() const;
    peak_envelope_follower& operator=(float y_);
    void                    release(duration release_, float sps);
};
```

== Expressions

=== Notation

`agc`, `a`, `b`     :: Instances of `agc`
`max`, `ref`        :: Instances of `decibel`

=== Constructors and Assignment

[cols="1,1"]
|===
| Expression    | Semantics

| `agc(max)`    | Construct an `agc` from `max` (maximum) gain.
| `agc(c)`      | Copy construct from `agc c`.
| `a = b`       | Assign `b`, to `a`.
|===

NOTE: C++ brace initialization may also be used.

As previously stated, the `agc` compares the envelope, `env`, to an external reference, `ref`, and adjusts the gain accordingly to maintain a constant output level. However, there is a maximum gain that can be applied when the signal falls below the reference. The `max` constructor parameter specified this "maximum" gain.

=== Function Call

[cols="1,1,1"]
|===
| Expression        | Semantics                             | Return Type

| `agc(env, ref)`   | Process the input envelope `env`
                      by increasing or decreasing the gain
                      if `env` goes above, or falls below
                      `ref` to maintain a constant output
                      level.                                | `decibel`
|===

The output is the adjusted gain, also in `decibels`. Simply multiply the signal by the result converted to `float` using `as_float` (or `double` using `as_double`). For example:

```c++
auto gain = as_float(agc(env, ref));    <1>
auto out = signal * gain;               <2>
```

<1> `env` is the computed envelope (e.g.) using an envelope follower.
    `gain` is obtained from the `env` processed by `agc` and converted to `float`.
<2> The `signal` multiplied by `gain`.

=== Mutators

[cols="1,1,1"]
|===
| Expression        | Semantics                         | Return Type

| `agc.max(max)`    | Set the `agc` maximum gain.       | `void`
|===

=== Accessors

[cols="1,1,1"]
|===
| Expression        | Semantics                         | Return Type

| `agc.max()`       | Get the `agc` maximum gain.       | `float`
|===

