= AR Envelope Follower

include::../../common.adoc[]

AR Envelope Follower, where "AR" stands for _Attack-Release_, is similar to the {peak_envelope_follower} but allows you to specify the attack duration. During the attack phase of an audio signal, the AR envelope follower attempts to follow the signal but is constrained by the attack duration. A longer attack period gives a softer response, exponentially increasing. When the signal level drops below the peak, the follower gradually releases the peak level with an exponential decay.

image:ar-peak-detector.svg[alt="AR Peak Detector", width=300, role=right]The AR envelope follower models the behavior of two resistors, one for attack, and one for release, each connected in series with an ideal diode —with no voltage drop—, tied together and connected to a capacitor. During attacks, the capacitor charges through the attack resistor, exponentially increasing. The capacitor discharges through the release resistor as the audio signal falls below the peak charge, causing the output voltage to progressively decay with an exponential curve.

image::ar-envelope-follower.png[alt="AR Envelope Follower", title="AR envelope follower response", width="750px" align=center, link={imagesdir}/peak-envelope-follower.png]

The plot in Figure 1 depicts the response of the AR envelope follower, which was obtained by picking the guitar's low-E string and using a 2-milliseconds attack duration and 2-second release duration (envelope: magenta, signal: blue, absolute value of the signal: dark blue).

It is worth noting that we use the absolute value of the signal to capture both the positive and negative sides of the waveform, as indicated by the dark blue plot. The AR envelope follower does not perform this operation automatically, allowing you to perform any necessary preprocessing before computing the envelope. This flexibility enables you, for example, to capture only the positive or negative peaks, or perhaps the square of the signal, depending on your application needs.

Like the {peak_envelope_follower}, the AR Peak Detector is susceptible to having ripples in the envelope with the short release durations. See {envelope_ripples} for details.

== Include

```c++
#include <q/fx/envelope.hpp>
```

== Declaration

```c++
struct peak_envelope_follower
{
                            peak_envelope_follower(duration release, float sps);

    float                   operator()(float s);
    float                   operator()() const;
    peak_envelope_follower& operator=(float y);
    void                    release(duration release_, float sps);
};
```

== Expressions

=== Notation

`env`, `a`, `b`     :: Instances of `peak_envelope_follower`
`r`                 :: Instance of `duration`
`sps`               :: Scalar value for samples per second.
`s`                 :: Scalar value for the latest input sample.
`y`                 :: Scalar value from 0.0 to 1.0.

=== Constructors and Assignment

[cols="1,1"]
|===
| Expression    | Semantics

| `env(r, sps)` | Construct a `peak_envelope_follower` given `r` (release time) and `sps` (samples per second).
| `agc(c)`      | Copy construct from `agc c`.
| `a = b`       | Assign `b` to `a`.
| `a = y`       | Reset the latest held value of the `peak_envelope_follower` to `y`.
|===

NOTE: C++ brace initialization may also be used.

=== Function Call

[cols="1,1,1"]
|===
| Expression        | Semantics                             | Return Type

| `env(s)`          | Process the input sample `s` and
                      return the peak detected result       | `float`
| `env()`           | Get the latest held value of the
                      `peak_envelope_follower`              | `float`
|===

=== Mutators

[cols="1,1,1"]
|===
| Expression            | Semantics                         | Return Type

| `env.release(r, sps)` | Set the release duration given
                          `r` (release time) and `sps`
                          (samples per second)              | `void`
|===



